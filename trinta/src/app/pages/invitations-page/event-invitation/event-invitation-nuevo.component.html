<mat-card class="event-card">
  <!-- Header con gradiente y botón de cerrar -->
  <div class="header-gradient">
    <img src="assets/images/Passo_Logo_64.png" alt="Passo" class="brand" />
    <div class="heading">
      <h1>Registrar un evento</h1>
      <p>Crea la invitación y compártela en segundos.</p>
    </div>
    <button mat-icon-button class="close-btn" (click)="onClose()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-card-content class="content">
    <form [formGroup]="form">
      <mat-stepper #stepper orientation="vertical" [linear]="false" class="mobile-stepper">

        <!-- STEP 1: Información -->
        <mat-step>
          <ng-template matStepLabel>Información</ng-template>

          <div class="section">
            <!-- Imagen -->
            <div class="image-drop" (click)="fileInput.click()">
              <ng-container *ngIf="imagePreview; else addImg">
                <img [src]="imagePreview" class="image-preview" alt="Imagen del evento" />
              </ng-container>
              <ng-template #addImg>
                <div class="image-placeholder">
                  <mat-icon>add_a_photo</mat-icon>
                  <span>Agregar imagen (recomendado)</span>
                </div>
              </ng-template>
              <input #fileInput type="file" accept="image/*" hidden (change)="onFileSelected($event)" />
            </div>

            <!-- Errores de imagen -->
            <div class="form-error" *ngIf="form.get('image')?.touched">
              <div *ngIf="form.get('image')?.hasError('tooLarge')">El archivo excede 5 MB.</div>
              <div *ngIf="form.get('image')?.hasError('badExt')">Solo imágenes .png, .jpg, .jpeg, .webp.</div>
              <div *ngIf="form.get('image')?.hasError('required')">La imagen es requerida.</div>
            </div>

            <!-- NOMBRE -->
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="full field">
              <mat-label>Nombre del evento</mat-label>
              <mat-icon matPrefix>badge</mat-icon>
              <input matInput formControlName="name" minlength="4" maxlength="50" />
              <mat-error class="form-error" *ngIf="form.get('name')?.hasError('required')">El nombre es requerido.</mat-error>
              <mat-error class="form-error" *ngIf="form.get('name')?.hasError('minlength')">Debe tener al menos 4 caracteres.</mat-error>
              <mat-error class="form-error" *ngIf="form.get('name')?.hasError('maxlength')">No puede exceder 50 caracteres.</mat-error>
            </mat-form-field>

            <!-- <div class="form-error" *ngIf="form.get('name')?.touched">
              <div *ngIf="form.get('name')?.hasError('required')">El nombre es requerido.</div>
              <div *ngIf="form.get('name')?.hasError('minlength')">Debe tener al menos 4 caracteres.</div>
              <div *ngIf="form.get('name')?.hasError('maxlength')">No puede exceder 50 caracteres.</div>
            </div> -->

            <!-- DIRECCIÓN -->
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="full field">
              <mat-label>Dirección</mat-label>
              <mat-icon matPrefix>home_pin</mat-icon>
              <mat-select formControlName="neighborAddressId">
                <mat-option *ngFor="let loc of Adresses" [value]="loc.id">{{ loc.fullAddress }}</mat-option>
              </mat-select>
              <mat-error class="form-error" *ngIf="form.get('neighborAddressId')?.hasError('required')">
                La dirección es requerida.
              </mat-error>
            </mat-form-field>
          </div>

          <div class="step-actions">
            <button mat-fab color="primary" (click)="onStepNext(1, stepper)">
              <mat-icon>arrow_downward</mat-icon>
            </button>
          </div>
        </mat-step>

        <!-- STEP 2: Fecha y hora -->
        <mat-step>
          <ng-template matStepLabel>Fecha y hora</ng-template>

          <div class="section grid-2">
            <!-- Fecha -->
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="full field">
              <mat-label>Fecha del evento</mat-label>
              <mat-icon matPrefix>event</mat-icon>
              <input matInput formControlName="startTime" [matDatepicker]="pickerInicio" />
              <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
              <mat-datepicker #pickerInicio touchUi></mat-datepicker>

              <!-- error nativo del form-field (sale en rojo) -->
              <mat-error *ngIf="form.get('startTime')?.hasError('required')">
                La fecha de inicio es requerida.
              </mat-error>
            </mat-form-field>

            <!-- Validación de rango de fechas (si aplica en tu form) -->
            <div class="form-error" *ngIf="form.hasError('dateRangeInvalid')">
              La fecha de inicio no puede ser mayor que la fecha final.
            </div>

            <!-- Horas como chips -->
            <div class="chip-card" [class.invalid]="form.hasError('timeRangeInvalid')">
              <div class="chip-row">
                <div class="chip">
                  <mat-icon>schedule</mat-icon>
                  <div>
                    <div class="chip-label">Inicia</div>
                    <input type="time" class="chip-input" formControlName="startTimeHour" step="60" />
                  </div>
                </div>
                <div class="chip">
                  <mat-icon>alarm_on</mat-icon>
                  <div>
                    <div class="chip-label">Termina</div>
                    <input type="time" class="chip-input" formControlName="endTimeHour" step="60" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Errores horas -->
            <div class="form-error" *ngIf="form.get('startTimeHour')?.touched && form.get('startTimeHour')?.invalid">
              <div *ngIf="form.get('startTimeHour')?.hasError('required')">La hora de inicio es requerida.</div>
            </div>
            <div class="form-error" *ngIf="form.get('endTimeHour')?.touched && form.get('endTimeHour')?.invalid">
              <div *ngIf="form.get('endTimeHour')?.hasError('required')">La hora de fin es requerida.</div>
            </div>
            <div class="form-error"
                 *ngIf="form.hasError('timeRangeInvalid') && (form.get('startTimeHour')?.touched || form.get('endTimeHour')?.touched)">
              La hora de inicio no puede ser mayor que la hora de fin.
            </div>
          </div>

          <div class="step-actions between">
            <button mat-fab (click)="stepper.previous()">
              <mat-icon>arrow_upward</mat-icon>
            </button>
            <button mat-fab color="primary" (click)="onStepNext(2, stepper)">
              <mat-icon>arrow_downward</mat-icon>
            </button>
          </div>
        </mat-step>

        <!-- STEP 3: Compartir -->
        <mat-step>
          <ng-template matStepLabel>Compartir</ng-template>

          <div class="section">
            <div class="share-card">
              <!-- Encabezado compacto -->
              <div class="share-header">
                <img src="assets/images/Passo_Logo_64.png" alt="Passo" class="brand" />
                <div class="titles">
                  <h3>Revisa y comparte</h3>
                  <p>Confirma los datos del evento antes de enviar la invitación.</p>
                </div>
              </div>

              <!-- Imagen / preview -->
              <div class="preview-block" *ngIf="imagePreview; else noImg">
                <img [src]="imagePreview" alt="Imagen del evento" class="preview-img" />
                <!-- <div class="preview-caption">
                  {{ form.controls['name'].value || 'Evento' }}
                </div> -->
              </div>
              <ng-template #noImg>
                <div class="preview-empty">
                  <mat-icon>image</mat-icon>
                  <span>Sin imagen</span>
                </div>
              </ng-template>

              <!-- Datos del evento -->
      <!-- Datos del evento -->
      <div class="info-list-compact">
        <!-- Nombre -->
        <div class="item">
          <div class="bullet cyan">
            <span class="material-symbols-outlined">celebration</span>
          </div>
          <div class="content">
            <div class="label">Nombre del evento</div>
            <div class="value">{{ form.controls['name'].value }}</div>
          </div>
        </div>

        <!-- Fecha -->
        <div class="item">
          <div class="bullet green">
            <span class="material-symbols-outlined">calendar_month</span>
          </div>
          <div class="content">
            <div class="label">Fecha</div>
            <div class="value">{{ form.controls['startTime'].value | date:'dd/MM/yyyy' }}</div>
          </div>
        </div>

        <!-- Horario -->
        <div class="item">
          <div class="bullet blue">
            <span class="material-symbols-outlined">schedule</span>
          </div>
          <div class="content">
            <div class="label">Horario</div>
            <div class="value">
              {{ formatTimeRange(form.value.startTimeHour, form.value.endTimeHour) }}
            </div>
          </div>
        </div>

        <!-- Locación -->
        <div class="item">
          <div class="bullet purple">
            <span class="material-symbols-outlined">home_pin</span>
          </div>
          <div class="content">
            <div class="label">Dirección</div>
            <div class="value">{{ getFullAddress() }}</div>
          </div>
        </div>
      </div>
            </div>
          </div>

          <!-- Acciones sticky -->
          <div class="sticky-actions">
            <!-- <button type="button" class="ghost-btn" (click)="stepper.previous()">
              <mat-icon>arrow_back</mat-icon>
              Atrás
            </button> -->
            <button mat-fab (click)="stepper.previous()">
              <mat-icon>arrow_upward</mat-icon>
            </button>
            <button mat-flat-button color="primary" class="cta-btn" (click)="onSubmit()">
              <mat-icon>share</mat-icon>
              Compartir invitación
            </button>
          </div>
        </mat-step>

      </mat-stepper>
    </form>
  </mat-card-content>
</mat-card>
